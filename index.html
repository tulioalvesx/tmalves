<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal de Notícias — RSS Aggregator</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark">
  <style>
    /* Evita layout shift do dialog */
    dialog::backdrop { backdrop-filter: blur(1px); }
    /* Cartão */
    .card-desc p { margin-bottom: .5rem; }
    .line-clamp-4 {
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;  
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 z-50 grid place-items-center bg-white/90">
    <div class="w-[92vw] max-w-xl rounded-2xl p-6 shadow-xl bg-white border border-slate-200">
      <div class="flex flex-col items-center gap-4">
        <!-- Logo central -->
        <div class="flex items-center gap-3">
          <div class="size-10 rounded-lg bg-indigo-600"></div>
          <span class="text-2xl font-semibold">TMA News</span>
        </div>
        <!-- Barra de progresso -->
        <div class="w-full">
          <div class="flex justify-between text-sm mb-1">
            <span>Carregando notícias…</span>
            <span id="progressPct">0%</span>
          </div>
          <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden">
            <div id="progressBar" class="h-3 w-0 bg-indigo-600 transition-[width]"></div>
          </div>
          <p id="statusText" class="text-xs text-slate-600 mt-2">Iniciando…</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/70 border-b border-slate-200">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3 px-4 py-3">
      <div class="flex items-center gap-3">
        <div class="size-8 rounded-md bg-indigo-600"></div>
        <h1 class="text-xl font-semibold">Portal de Notícias</h1>
      </div>
      <div class="flex items-center gap-2 w-full max-w-xl">
        <input id="searchInput" type="text" placeholder="Pesquisar (título ou texto)…"
               class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        <select id="sourceFilter"
                class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="__all__" selected>Todas as fontes</option>
        </select>
        <button id="btnSettings"
                class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50">Fontes</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Destaques -->
    <section id="highlights" class="mb-8 hidden">
      <h2 class="text-lg font-semibold mb-3">Destaques</h2>
      <div id="highlightGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- Lista -->
    <section>
      <div id="list" class="grid grid-cols-1 gap-4"></div>
      <p id="emptyState" class="text-slate-600 text-center py-12 hidden">Nenhuma notícia encontrada.</p>
    </section>
  </main>

  <!-- Modal de Fontes (fechado por padrão) -->
  <dialog id="settingsModal" class="backdrop:bg-black/40 rounded-xl p-0 w-[720px] max-w-[92vw]">
    <form method="dialog" class="bg-white rounded-xl overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200">
        <h3 class="text-lg font-semibold">Gerenciar Fontes RSS</h3>
        <button class="px-2 py-1 rounded-md hover:bg-slate-100" value="cancel">Fechar</button>
      </div>
      <div class="p-5 space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-[1fr,auto] gap-3">
          <input id="newSourceName" type="text" placeholder="Nome da fonte (ex.: G1)"
                 class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <input id="newSourceUrl" type="url" placeholder="URL do RSS/Atom"
                 class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="flex justify-end">
          <button id="btnAddSource" class="rounded-lg bg-indigo-600 text-white px-3 py-2 text-sm hover:bg-indigo-700">
            Adicionar
          </button>
        </div>
        <div>
          <h4 class="font-medium mb-2">Fontes Atuais</h4>
          <ul id="sourcesList" class="space-y-2"></ul>
        </div>
      </div>
      <div class="px-5 py-4 border-t border-slate-200 text-sm text-slate-600">
        Dica: as fontes ficam salvas no seu navegador (localStorage).
      </div>
    </form>
  </dialog>

  <script>
    // ========= Storage de fontes =========
    const LS_KEY = "tma_news_sources_v1";
    let SOURCES = [];
    let ALL_ITEMS = [];
    const overlay = document.getElementById('loadingOverlay');
    const progressBar = document.getElementById('progressBar');
    const progressPct = document.getElementById('progressPct');
    const statusText  = document.getElementById('statusText');
    const listEl = document.getElementById('list');
    const emptyStateEl = document.getElementById('emptyState');
    const sourceFilter = document.getElementById('sourceFilter');
    const searchInput = document.getElementById('searchInput');
    const highlights = document.getElementById('highlights');
    const highlightGrid = document.getElementById('highlightGrid');

    function defaultSources() {
      return [
        { name: "G1", url: "https://g1.globo.com/rss/g1/", type: "rss" },
        { name: "Folha", url: "https://feeds.folha.uol.com.br/emcimadahora/rss091.xml", type: "rss" },
        { name: "Estadão", url: "https://feeds.folha.uol.com.br/mundo/rss091.xml", type: "rss" },
        { name: "BBC Brasil", url: "https://feeds.bbci.co.uk/portuguese/rss.xml", type: "rss" },
      ];
    }

    function loadSources() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return defaultSources();
        const data = JSON.parse(raw);
        if (!Array.isArray(data) || data.length === 0) return defaultSources();
        return data;
      } catch {
        return defaultSources();
      }
    }

    function saveSources(next) {
      localStorage.setItem(LS_KEY, JSON.stringify(next));
      SOURCES = next;
      populateSourceFilter();
    }

    function populateSourceFilter() {
      // limpa mantendo o "Todas"
      sourceFilter.innerHTML = '<option value="__all__">Todas as fontes</option>';
      for (const s of SOURCES) {
        const opt = document.createElement('option');
        opt.value = s.name;
        opt.textContent = s.name;
        sourceFilter.appendChild(opt);
      }
    }

    // ========= Progresso & status =========
    function updateProgress(pct) {
      const clamped = Math.max(0, Math.min(100, pct|0));
      progressBar.style.width = clamped + '%';
      progressPct.textContent = clamped + '%';
    }
    function setStatus(msg) { statusText.textContent = msg; }

    // ========= Proxy robusto (garante XML) =========
    async function fetchWithFallback(url) {
      const attempts = [
        // AllOrigins (JSON) — mais estável que /raw
        async () => {
          const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
          if (!res.ok) throw new Error('allorigins get ' + res.status);
          const j = await res.json();
          return j.contents; // XML string
        },
        // isomorphic-git CORS proxy
        async () => {
          const res = await fetch(`https://cors.isomorphic-git.org/${url}`);
          if (!res.ok) throw new Error('isomorphic ' + res.status);
          return await res.text();
        },
        // r.jina.ai — somente se realmente vier XML
        async () => {
          const res = await fetch(`https://r.jina.ai/http://${url.replace(/^https?:\/\//, '')}`);
          if (!res.ok) throw new Error('jina ' + res.status);
          const t = await res.text();
          if (!t.includes('<rss') && !t.includes('<feed')) throw new Error('jina not xml');
          return t;
        }
      ];
      let lastErr;
      for (const step of attempts) {
        try {
          const txt = await step();
          return txt;
        } catch (e) {
          lastErr = e;
          console.warn('Falha proxy', e);
        }
      }
      throw lastErr || new Error('Sem proxy disponível');
    }

    // ========= Parse RSS/Atom =========
    function textContentSafe(el, sel, fallback = "") {
      const n = el.querySelector(sel);
      return n ? (n.textContent || "").trim() : fallback;
    }
    function attr(el, sel, attr) {
      const n = el.querySelector(sel);
      return n ? n.getAttribute(attr) : null;
    }
    function getImageFromItem(item) {
      // RSS comuns
      let url = item.querySelector('media\\:content, content')?.getAttribute('url')
             || item.querySelector('media\\:thumbnail')?.getAttribute('url')
             || item.querySelector('enclosure')?.getAttribute('url')
             || item.querySelector('img')?.getAttribute('src');
      if (!url) {
        const desc = textContentSafe(item, 'description');
        const m = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
        if (m) url = m[1];
      }
      return url;
    }
    function normalizeText(html) {
      if (!html) return "";
      // remove tags básicas mantendo texto
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }
    function parseRSS(xmlText, sourceName) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlText, "text/xml");
      if (xml.querySelector("parsererror")) {
        throw new Error("XML inválido para " + sourceName);
      }
      const out = [];
      // RSS 2.0
      const rssItems = xml.querySelectorAll("rss channel item");
      rssItems.forEach(item => {
        const title = textContentSafe(item, "title", "(Sem título)");
        const link = textContentSafe(item, "link", "#");
        const pubDateRaw = textContentSafe(item, "pubDate") || textContentSafe(item, "dc\\:date");
        const pubDate = pubDateRaw ? new Date(pubDateRaw) : new Date();
        const description = textContentSafe(item, "description");
        const image = getImageFromItem(item);
        out.push({ title, link, pubDate, description, image, source: sourceName });
      });
      if (out.length) return out;

      // Atom
      const atomEntries = xml.querySelectorAll("feed entry");
      atomEntries.forEach(entry => {
        const title = textContentSafe(entry, "title", "(Sem título)");
        let link = attr(entry, "link", "href") || "#";
        const pubDateRaw = textContentSafe(entry, "updated") || textContentSafe(entry, "published");
        const pubDate = pubDateRaw ? new Date(pubDateRaw) : new Date();
        const summary = textContentSafe(entry, "summary") || textContentSafe(entry, "content");
        const image = getImageFromItem(entry);
        out.push({ title, link, pubDate, description: summary, image, source: sourceName });
      });
      return out;
    }

    async function fetchRSS(source) {
      const xml = await fetchWithFallback(source.url);
      return parseRSS(xml, source.name);
    }

    // ========= Render =========
    function formatDate(d) {
      try {
        return new Intl.DateTimeFormat('pt-BR', {
          dateStyle: 'medium',
          timeStyle: 'short'
        }).format(d);
      } catch {
        return d.toLocaleString();
      }
    }
    function matchesSearch(item, term) {
      if (!term) return true;
      term = term.toLowerCase();
      return (item.title?.toLowerCase().includes(term) || item.description?.toLowerCase().includes(term));
    }
    function applyFilters(items) {
      const src = sourceFilter.value;
      const term = searchInput.value.trim();
      return items.filter(it => (src === '__all__' || it.source === src) && matchesSearch(it, term));
    }

    function renderHighlights(items) {
      const top = items.slice(0, 6);
      if (!top.length) {
        highlights.classList.add('hidden');
        highlightGrid.innerHTML = '';
        return;
      }
      highlights.classList.remove('hidden');
      highlightGrid.innerHTML = top.map(it => `
        <a class="block rounded-xl border border-slate-200 bg-white hover:shadow-md transition p-4"
           href="${it.link}" target="_blank" rel="noopener">
          <div class="flex gap-3">
            <div class="w-24 h-24 shrink-0 rounded-lg bg-slate-100 overflow-hidden flex items-center justify-center">
              ${it.image ? `<img src="${it.image}" alt="" class="w-full h-full object-cover">` : `<div class="text-slate-400 text-sm">Sem imagem</div>`}
            </div>
            <div class="min-w-0">
              <div class="text-sm text-slate-500">${it.source} • ${formatDate(it.pubDate)}</div>
              <h3 class="font-semibold line-clamp-2">${it.title}</h3>
            </div>
          </div>
        </a>
      `).join('');
    }

    function render() {
      const items = applyFilters(ALL_ITEMS);
      emptyStateEl.classList.toggle('hidden', items.length > 0);

      // Destaques = primeiros itens recentes com imagem
      const withImg = items.filter(x => !!x.image);
      renderHighlights(withImg);

      listEl.innerHTML = items.map(it => `
        <article class="rounded-xl border border-slate-200 bg-white hover:shadow-sm transition p-4">
          <a href="${it.link}" target="_blank" rel="noopener" class="block">
            <div class="flex items-start gap-4">
              <div class="w-24 h-24 shrink-0 rounded-lg bg-slate-100 overflow-hidden flex items-center justify-center">
                ${it.image ? `<img src="${it.image}" alt="" class="w-full h-full object-cover">` : `<div class="text-slate-400 text-sm">Sem imagem</div>`}
              </div>
              <div class="min-w-0">
                <div class="text-sm text-slate-500">${it.source} • ${formatDate(it.pubDate)}</div>
                <h3 class="text-lg font-semibold mb-1">${it.title}</h3>
                <div class="card-desc text-sm text-slate-700 line-clamp-4">${(it.description || '').replace(/</g,'&lt;')}</div>
              </div>
            </div>
          </a>
        </article>
      `).join('');
    }

    // ========= Fluxo principal =========
    async function loadAll() {
      overlay.style.display = 'grid';
      setStatus('Carregando…');
      ALL_ITEMS = [];
      const total = SOURCES.length;
      let done = 0;
      updateProgress(0);

      const tasks = SOURCES.map(async (s) => {
        try {
          const items = (await fetchRSS(s)).map(x => ({ ...x, description: normalizeText(x.description) }));
          ALL_ITEMS = ALL_ITEMS.concat(items);
        } catch (e) {
          console.warn('Erro em', s.name, e);
        }
        done++;
        updateProgress(Math.round(done * 100 / Math.max(1,total)));
        render(); // render parcial
      });

      await Promise.all(tasks);
      ALL_ITEMS.sort((a, b) => b.pubDate - a.pubDate);
      render();
      setStatus('Pronto');
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 300); // deixa a barra chegar a 100%
    }

    // ========= Modal / Segurança simples =========
    const settingsModal = document.getElementById('settingsModal');
    document.getElementById('btnSettings').addEventListener('click', () => {
      const user = prompt('Usuário:');
      const pass = user ? prompt('Senha:') : null;
      if (user === 'adm' && pass === '@mudar') {
        mountSourcesList();
        settingsModal.showModal();
      } else {
        alert('Acesso negado.');
      }
    });

    function mountSourcesList() {
      const ul = document.getElementById('sourcesList');
      ul.innerHTML = '';
      SOURCES.forEach((s, idx) => {
        const li = document.createElement('li');
        li.className = "flex items-center justify-between gap-3 rounded-lg border border-slate-200 bg-white px-3 py-2";
        li.innerHTML = `
          <div class="min-w-0">
            <div class="font-medium truncate">${s.name}</div>
            <div class="text-xs text-slate-500 truncate">${s.url}</div>
          </div>
          <button data-i="${idx}" class="btn-rem rounded-md border border-slate-300 px-2 py-1 text-xs hover:bg-slate-50">
            Remover
          </button>
        `;
        ul.appendChild(li);
      });
      ul.querySelectorAll('.btn-rem').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const i = Number(e.currentTarget.dataset.i);
          const next = [...SOURCES.slice(0,i), ...SOURCES.slice(i+1)];
          saveSources(next);
          mountSourcesList();
          loadAll(); // recarrega com fontes atualizadas
        });
      });
    }

    document.getElementById('btnAddSource').addEventListener('click', (e) => {
      e.preventDefault();
      const name = document.getElementById('newSourceName').value.trim();
      const url  = document.getElementById('newSourceUrl').value.trim();
      if (!name || !url) return alert('Informe nome e URL.');
      const next = [...SOURCES, { name, url, type: 'rss' }];
      saveSources(next);
      document.getElementById('newSourceName').value = '';
      document.getElementById('newSourceUrl').value = '';
      mountSourcesList();
      loadAll();
    });

    // filtros
    sourceFilter.addEventListener('change', render);
    searchInput.addEventListener('input', () => {
      render();
    });

    // boot
    (async function init() {
      SOURCES = loadSources();
      populateSourceFilter();
      await loadAll();
    })();
  </script>
</body>
</html>
