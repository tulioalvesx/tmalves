<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TMA News — Portal de Notícias (Resiliente)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .bar-red{height:3px;background-image:linear-gradient(to right,#d10,#f33)}
    #progressBar{transition:width .2s ease}
    .line-clamp-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .shadow-soft{box-shadow:0 8px 24px rgba(0,0,0,.06)}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="loadingOverlay" class="fixed inset-0 z-[100] grid place-items-center bg-white">
    <div class="w-[92vw] max-w-md text-center">
      <img src="logo-escudo.png" alt="Logo" class="mx-auto w-28 h-28 object-contain mb-4" />
      <h1 class="text-2xl font-semibold mb-4">TMA News</h1>
      <div class="w-full text-left">
        <div class="flex justify-between text-sm mb-1">
          <span>Status</span><span id="progressPct">0%</span>
        </div>
        <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden">
          <div id="progressBar" class="h-3 w-0 bg-red-600"></div>
        </div>
        <p id="statusText" class="text-xs text-slate-600 mt-2">Inicializando…</p>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-40 bg-white/95 backdrop-blur border-b border-slate-200">
    <div class="bar-red w-full"></div>
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex items-center justify-between py-3">
        <div class="flex items-center gap-3">
          <img src="logo-escudo.png" class="w-8 h-8"/>
          <span class="text-xl font-bold">TMA News</span>
        </div>
        <div class="flex items-center gap-2 w-full max-w-xl">
          <input id="searchInput" class="w-full rounded-md border px-3 py-2 text-sm" placeholder="Pesquisar…"/>
          <select id="sourceFilter" class="rounded-md border px-3 py-2 text-sm">
            <option value="__all__">Todas as fontes</option>
          </select>
          <button id="btnSettings" class="rounded-md border px-3 py-2 text-sm">Fontes</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="mb-8">
      <div id="highlightGrid" class="grid grid-cols-1 lg:grid-cols-3 lg:[grid-template-rows:repeat(2,minmax(0,1fr))] gap-4"></div>
    </section>
    <section>
      <div id="list" class="grid grid-cols-1 gap-4"></div>
      <p id="emptyState" class="text-slate-600 text-center py-12 hidden">Nenhuma notícia.</p>
    </section>
  </main>

  <script>
    const LS_KEY="tma_news_sources_v1";
    const overlay=document.getElementById('loadingOverlay');
    const progressBar=document.getElementById('progressBar');
    const progressPct=document.getElementById('progressPct');
    const statusText=document.getElementById('statusText');
    const sourceFilter=document.getElementById('sourceFilter');
    const searchInput=document.getElementById('searchInput');
    const highlightGrid=document.getElementById('highlightGrid');
    const listEl=document.getElementById('list');
    const emptyState=document.getElementById('emptyState');
    let SOURCES=[], ALL_ITEMS=[];

    const SOURCE_LOGOS={
      "G1":"https://g1.globo.com/favicon.ico",
      "Folha":"https://www.folha.uol.com.br/favicon.ico",
      "BBC Brasil":"https://www.bbc.com/favicon.ico",
      "TeleSíntese":"https://telesintese.com.br/wp-content/uploads/2020/02/cropped-favicon-192x192.png",
      "TELETIME":"https://teletime.com.br/wp-content/uploads/2020/02/cropped-favicon-192x192.png"
    };

    function defaultSources(){
      return [
        {name:"TeleSíntese",url:"https://telesintese.com.br/feed/" },
        {name:"TELETIME",url:"https://teletime.com.br/feed/" },
        {name:"G1",url:"https://g1.globo.com/rss/g1/" },
        {name:"Folha",url:"https://feeds.folha.uol.com.br/emcimadahora/rss091.xml"},
        {name:"BBC Brasil",url:"https://feeds.bbci.co.uk/portuguese/rss.xml"}
      ];
    }
    function loadSources(){
      try{
        const raw=localStorage.getItem(LS_KEY);
        const data=raw?JSON.parse(raw):null;
        return Array.isArray(data)&&data.length?data:defaultSources();
      }catch{return defaultSources();}
    }
    function populateSourceFilter(){
      sourceFilter.innerHTML='<option value="__all__">Todas as fontes</option>';
      for(const s of SOURCES){
        const o=document.createElement('option'); o.value=s.name; o.textContent=s.name; sourceFilter.appendChild(o);
      }
    }
    function setStatus(msg){ statusText.textContent=msg; }
    function updateProgress(p){ p=Math.max(0,Math.min(100, p|0)); progressBar.style.width=p+'%'; progressPct.textContent=p+'%'; }

    // Watchdog: if progress <5% after 5s, bump to 10%
    setTimeout(()=>{ const w=progressBar.style.width||'0%'; if(parseInt(w)<5){ updateProgress(10); setStatus('Iniciando fontes…'); } }, 5000);
    // Auto-dismiss after 15s no matter what
    setTimeout(()=>{ if(getComputedStyle(overlay).display!=='none'){ setStatus('Carregando em segundo plano…'); overlay.style.display='none'; } }, 15000);

    const timeout = (ms)=> new Promise((_,rej)=> setTimeout(()=>rej(new Error('timeout')),ms));
    async function fetchWithTimeout(url, ms=8000){
      return Promise.race([ fetch(url), timeout(ms) ]);
    }
    async function fetchTextThroughProxies(url){
      const attempts=[
        async()=>{ const r=await fetchWithTimeout(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`); if(!r.ok)throw 0; const j=await r.json(); return j.contents; },
        async()=>{ const r=await fetchWithTimeout(`https://cors.isomorphic-git.org/${url}`); if(!r.ok)throw 0; return await r.text(); },
        async()=>{ const r=await fetchWithTimeout(`https://r.jina.ai/http://${url.replace(/^https?:\/\//,'')}`); if(!r.ok)throw 0; return await r.text(); }
      ];
      let last; for(const a of attempts){ try{ return await a(); }catch(e){ last=e; } }
      throw last||new Error('proxy fail');
    }
    function fixEncoding(s){ if(!s||!s.includes('�'))return s; try{ const bytes=new Uint8Array(s.split('').map(ch=>ch.charCodeAt(0))); return new TextDecoder('iso-8859-1').decode(bytes);}catch{return s;} }
    function resolveUrl(base, url){ try{ return new URL(url, base).href; }catch{ return url; } }

    function parseRSS(xmlText, sourceName){
      const parser=new DOMParser(); const xml=parser.parseFromString(xmlText,"text/xml");
      const out=[];
      xml.querySelectorAll("rss channel item").forEach(item=>{
        const title=(item.querySelector("title")?.textContent||"(Sem título)").trim();
        const link=(item.querySelector("link")?.textContent||"#").trim();
        const pub=(item.querySelector("pubDate")?.textContent||"").trim();
        const pubDate=pub?new Date(pub):new Date();
        const desc=(item.querySelector("description")?.textContent||"").trim();
        let image=item.querySelector('media\\:content')?.getAttribute('url')
                 || item.querySelector('media\\:thumbnail')?.getAttribute('url')
                 || item.querySelector('enclosure')?.getAttribute('url');
        if(!image){
          const html=(item.querySelector('content\\:encoded')?.textContent||desc);
          const m=(html||"").match(/<img[^>]+src=["']([^"']+)["']/i);
          if(m) image=m[1];
        }
        if(image) image=resolveUrl(link,image);
        out.push({title:fixEncoding(title), link, pubDate, description:fixEncoding(desc), image, source:sourceName});
      });
      if(out.length) return out;
      xml.querySelectorAll("feed entry").forEach(entry=>{
        const title=(entry.querySelector("title")?.textContent||"(Sem título)").trim();
        const link=entry.querySelector("link[rel='alternate']")?.getAttribute('href')||entry.querySelector("link")?.getAttribute('href')||"#";
        const pub=entry.querySelector("updated")?.textContent||entry.querySelector("published")?.textContent||"";
        const pubDate=pub?new Date(pub):new Date();
        const sum=(entry.querySelector("summary")?.textContent||entry.querySelector("content")?.textContent||"").trim();
        let image=entry.querySelector('media\\:content')?.getAttribute('url')||entry.querySelector('media\\:thumbnail')?.getAttribute('url');
        if(image) image=resolveUrl(link,image);
        out.push({title:fixEncoding(title), link, pubDate, description:fixEncoding(sum), image, source:sourceName});
      });
      return out;
    }

    function formatDate(d){ try{ return new Intl.DateTimeFormat('pt-BR',{dateStyle:'medium',timeStyle:'short'}).format(d);}catch{return d.toLocaleString();} }
    function hash(it){ return btoa(unescape(encodeURIComponent((it.link||'')+'|'+(it.title||'')))).replace(/=+$/,''); }
    function imgFor(it){ const src=it.image || SOURCE_LOGOS[it.source]; if(!src) return `<div class="w-28 h-28 bg-slate-200 rounded-md"></div>`; return `<img data-role="thumb" referrerpolicy="no-referrer" src="${src}" class="w-28 h-28 rounded-md object-cover">`; }

    function renderHighlights(items){
      const withImg=items.filter(x=>!!x.image);
      const a=withImg[0], b=withImg[1], c=withImg[2];
      function hero(x){
        if(!x) return '';
        const id=hash(x);
        return `<a href="${x.link}" target="_blank" rel="noopener"
                  class="group block rounded-xl overflow-hidden bg-white shadow-soft border border-slate-200 lg:col-span-2 lg:row-span-2 h-full">
                  <div class="relative h-64 lg:h-full">
                    <img data-hero="${id}" referrerpolicy="no-referrer" src="${x.image}" class="w-full h-full object-cover"/>
                  </div>
                  <div class="p-4">
                    <div class="text-sm text-slate-500">${x.source} • ${formatDate(x.pubDate)}</div>
                    <h2 class="text-2xl font-bold mt-1 mb-2 line-clamp-2">${x.title}</h2>
                    <p class="text-slate-700 line-clamp-3">${(x.description||'').replace(/</g,'&lt;')}</p>
                  </div>
                </a>`;
      }
      function small(x){
        if(!x) return '';
        const id=hash(x);
        return `<a href="${x.link}" target="_blank" rel="noopener"
                  class="group block rounded-xl overflow-hidden bg-white shadow-soft border border-slate-200 h-full">
                  <div class="relative h-40">
                    <img data-hero="${id}" referrerpolicy="no-referrer" src="${x.image}" class="w-full h-full object-cover"/>
                  </div>
                  <div class="p-4">
                    <div class="text-sm text-slate-500">${x.source} • ${formatDate(x.pubDate)}</div>
                    <h3 class="text-lg font-semibold mt-1 line-clamp-2">${x.title}</h3>
                  </div>
                </a>`;
      }
      highlightGrid.innerHTML = `${hero(a)}${small(b)}${small(c)}`;
    }

    function render(){
      let items=[...ALL_ITEMS].sort((a,b)=>b.pubDate-a.pubDate);
      if(sourceFilter.value==='__all__'){
        const withImg=items.filter(x=>x.image), without=items.filter(x=>!x.image);
        items=withImg.concat(without);
      }else{
        items=items.filter(x=>x.source===sourceFilter.value);
      }
      const term=searchInput.value.trim().toLowerCase();
      if(term) items=items.filter(x=>(x.title||'').toLowerCase().includes(term)||(x.description||'').toLowerCase().includes(term));

      emptyState.classList.toggle('hidden', items.length>0);
      renderHighlights(items);
      listEl.innerHTML = items.slice(0,20).map(it=>`
        <article class="rounded-xl border border-slate-200 bg-white p-4">
          <a href="${it.link}" target="_blank" rel="noopener" class="block">
            <div class="flex items-start gap-4">
              <div class="shrink-0">${imgFor(it)}</div>
              <div class="min-w-0">
                <div class="text-sm text-slate-500">${it.source} • ${formatDate(it.pubDate)}</div>
                <h3 class="text-lg font-semibold mb-1">${it.title}</h3>
                <p class="text-sm text-slate-700 line-clamp-3">${(it.description||'').replace(/</g,'&lt;')}</p>
              </div>
            </div>
          </a>
        </article>
      `).join('');
    }

    async function fetchRSS(source){
      let xml = await fetchTextThroughProxies(source.url);
      return parseRSS(xml, source.name);
    }

    async function loadAll(){
      try{
        overlay.style.display='grid';
        updateProgress(5); setStatus('Iniciando fontes…');
        ALL_ITEMS=[];
        const total = (SOURCES && SOURCES.length) ? SOURCES.length : 1;
        let done=0;
        const tasks = SOURCES.map(async (s)=>{
          try{
            const items=(await fetchRSS(s)).map(x=>({...x}));
            ALL_ITEMS=ALL_ITEMS.concat(items);
          }catch(e){
            console.warn('Erro fonte', s?.name, e);
          }finally{
            done++; updateProgress(Math.round(done*100/total)); setStatus(`Carregado ${done}/${total}`);
            if(done===1) render();
          }
        });
        await Promise.allSettled(tasks);
        render();
      }finally{
        setStatus('Pronto');
        setTimeout(()=>{ overlay.style.display='none'; }, 200);
      }
    }

    (async function init(){
      SOURCES = loadSources();
      populateSourceFilter();
      await loadAll();
      sourceFilter.addEventListener('change', render);
      searchInput.addEventListener('input', render);
    })();
  </script>
</body>
</html>
